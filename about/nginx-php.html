<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>nginx php-fpm安装配置-Nginx中文文档</title>
<link rel="stylesheet" type="text/css" media="all" href="../userguide.css" />
<script type="text/javascript" src="../nav/nav.js"></script>
<script type="text/javascript" src="../nav/prototype.lite.js"></script>
<script type="text/javascript" src="../nav/moo.fx.js"></script>
<script type="text/javascript" src="../nav/user_guide_menu.js"></script>
<meta name="robots" content="all" />
</head>
<body>
<!-- START NAVIGATION -->
<div id="nav2"><a name="top"></a><a href="../index.html" ><img src="../images/nav_toggle_darker.jpg" width="154" height="43" border="0" /></a></div>
<div id="masthead">
<table cellpadding="0" cellspacing="0" border="0" style="width:100%">
<tr>
<td><span id="sitename">Nginx中文文档</span></td>
<td id="breadcrumb_right"><a href="../index.html">目录首页</a></td>
</tr>
</table>
</div>
<!-- END NAVIGATION -->
<table cellpadding="0" cellspacing="0" border="0" style="width:100%">
<tr>
<td id="breadcrumb">
<a href="../index.html" >&nbsp;&#8250;&nbsp;nginx php-fpm安装配置
</td>
</tr>
</table>
<br clear="all" />
<!-- START CONTENT -->
<div id="content">
<h1>nginx php-fpm安装配置</h1>
[文章作者：张宴 本文版本：v6.3 最后修改：<span style="color: #FF0000;">2010.07.26</span> 转载请注明原文链接：<a href="http://blog.zyan.cc/nginx_php_v6/" target="_blank">http://blog.zyan.cc/nginx_php_v6/</a>]<br/><br/>　　前言：本文是我撰写的关于搭建“Nginx + PHP（FastCGI）”Web服务器的第6篇文章。本系列文章作为国内最早详细介绍 Nginx + PHP 安装、配置、使用的资料之一，为推动 Nginx 在国内的发展产生了积极的作用。本文可能不断更新小版本，请记住原文链接“<a href="http://blog.zyan.cc/nginx_php_v6/" target="_blank">http://blog.zyan.cc/nginx_php_v6/</a>”，获取最新内容。第6篇文章主要介绍了Nginx 0.8.x新的平滑重启方式，将PHP升级到了5.2.14，修正了PEAR问题。另将MySQL 5.1.x升级到了5.5.x系列，配置文件变更较大。<br/><br/>　　链接：《<a href="post/297/" target="_blank">2007年9月的第1版</a>》、《<a href="post/314/" target="_blank">2007年12月的第2版</a>》、《<a href="post/351/" target="_blank">2008年6月的第3版</a>》、《<a href="nginx_php_v4/" target="_blank">2008年8月的第4版</a>》、《<a href="nginx_php_v5/" target="_blank">2009年5月的第5版</a>》<br/><br/>　　<a href="nginx.png" target="_blank"><img src="nginx.png" class="insertimage" alt="点击在新窗口中浏览此图片" title="点击在新窗口中浏览此图片" border="0"/></a><br/><br/>　　<a href="http://www.nginx.net/" target="_blank">Nginx</a> ("engine x") 是一个高性能的 HTTP 和反向代理服务器，也是一个 IMAP/POP3/SMTP 代理服务器。 Nginx 是由 Igor Sysoev 为俄罗斯访问量第二的 Rambler.ru 站点开发的，它已经在该站点运行超过三年了。Igor 将源代码以类BSD许可证的形式发布。<br/><br/>　　Nginx 超越 Apache 的高性能和稳定性，使得国内使用 Nginx 作为 Web 服务器的网站也越来越多，其中包括<a href="http://blog.sina.com.cn/" target="_blank">新浪博客</a>、<a href="http://v.sina.com.cn/" target="_blank">新浪播客</a>、<a href="http://news.163.com/" target="_blank">网易新闻</a>、<a href="http://www.qq.com/" target="_blank">腾讯网</a>、<a href="http://blog.sohu.com/" target="_blank">搜狐博客</a>等门户网站频道，<a href="http://www.6.cn/" target="_blank">六间房</a>、<a href="http://www.56.com/" target="_blank">56.com</a>等视频分享网站，<a href="http://www.discuz.net/" target="_blank">Discuz!官方论坛</a>、<a href="http://www.newsmth.net/" target="_blank">水木社区</a>等知名论坛，<a href="http://www.sdo.com/" target="_blank">盛大在线</a>、<a href="http://www.xoyo.com/" target="_blank">金山逍遥网</a>等网络游戏网站，<a href="http://www.douban.com/" target="_blank">豆瓣</a>、<a href="http://www.renren.com/" target="_blank">人人网</a>、<a href="http://www.yupoo.com/" target="_blank">YUPOO相册</a>、<a href="http://www.iciba.com/" target="_blank">金山爱词霸</a>、<a href="http://www.xunlei.com/" target="_blank">迅雷在线</a>等新兴Web 2.0网站。<br/><br/><hr/><br/>　　Nginx 的官方中文维基：<a href="http://wiki.nginx.org/NginxChs" target="_blank">http://wiki.nginx.org/NginxChs</a><br/><br/><hr/><br/>　　在高并发连接的情况下，Nginx是Apache服务器不错的替代品。Nginx同时也可以作为7层负载均衡服务器来使用。根据我的测试结果，<strong>Nginx 0.8.46 + PHP 5.2.14 (FastCGI) 可以承受3万以上的并发连接数，相当于同等环境下Apache的10倍</strong>。<br/><br/>　　根据我的经验，4GB内存的服务器+Apache（prefork模式）一般只能处理3000个并发连接，因为它们将占用3GB以上的内存，还得为系统预留1GB的内存。我曾经就有两台Apache服务器，因为在配置文件中设置的MaxClients为4000，当Apache并发连接数达到3800时，导致服务器内存和Swap空间用满而崩溃。<br/><br/>　　而这台 Nginx 0.8.46 + PHP 5.2.14 (FastCGI) 服务器在3万并发连接下，开启的10个Nginx进程消耗150M内存（15M*10=150M），开启的64个php-cgi进程消耗1280M内存（20M*64=1280M），加上系统自身消耗的内存，总共消耗不到2GB内存。如果服务器内存较小，完全可以只开启25个php-cgi进程，这样php-cgi消耗的总内存数才500M。<br/><br/>　　在3万并发连接下，访问Nginx 0.8.46 + PHP 5.2.14 (FastCGI) 服务器的PHP程序，仍然速度飞快。下图为Nginx的状态监控页面，显示的活动连接数为28457（关于Nginx的监控页配置，会在本文接下来所给出的Nginx配置文件中写明）：<br/><br/>　　<a href="nginx_status.png" target="_blank"><img src="nginx_status.png" class="insertimage" alt="点击在新窗口中浏览此图片" title="点击在新窗口中浏览此图片" border="0"/></a><br/><br/>　　我生产环境下的两台Nginx + PHP5（FastCGI）服务器，跑多个一般复杂的纯PHP动态程序，单台Nginx + PHP5（FastCGI）服务器跑PHP动态程序的处理能力已经超过“<span style="color: #FF0000;">700次请求/秒</span>”，相当于每天可以承受6000万（700*60*60*24=60480000）的访问量（<a href="read.php/334.htm" target="_blank">更多信息见此</a>），而服务器的系统负载也不高：<br/><br/>　　<a href="nginx_php_la.gif" target="_blank"><img src="nginx_php_la.gif" class="insertimage" alt="点击在新窗口中浏览此图片" title="点击在新窗口中浏览此图片" border="0"/></a><br/><br/>　　2009年9月3日下午2：30，金山游戏《剑侠情缘网络版叁》临时维护1小时（<a href="http://kefu.xoyo.com/gonggao/jx3/2009-09-03/750438.shtml" target="_blank">http://kefu.xoyo.com/gonggao/jx3/2009-09-03/750438.shtml</a>），大量玩家上官网，论坛、评论、客服等动态应用Nginx服务器集群，每台服务器的Nginx活动连接数达到2.8万，这是笔者遇到的Nginx生产环境最高并发值。<br/><br/>　　<a href="nginx_c30k.png" target="_blank"><img src="nginx_c30k.png" class="insertimage" alt="点击在新窗口中浏览此图片" title="点击在新窗口中浏览此图片" border="0"/></a><br/><br/><hr/><br/>　　下面是用100个并发连接分别去压生产环境中同一负载均衡器VIP下、提供相同服务的两台服务器，一台为Nginx，另一台为Apache，Nginx每秒处理的请求数是Apache的两倍多，Nginx服务器的系统负载、CPU使用率远低于Apache：<br/><br/>　　你可以将连接数开到10000～30000，去压Nginx和Apache上的phpinfo.php，这是用浏览器访问Nginx上的phpinfo.php一切正常，而访问Apache服务器的phpinfo.php，则是该页无法显示。4G内存的服务器，即使再优化，Apache也很难在“webbench -c 30000 -t 60 <a href="http://xxx.xxx.xxx.xxx/phpinfo.php" target="_blank">http://xxx.xxx.xxx.xxx/phpinfo.php</a>”的压力情况下正常访问，而调整参数优化后的Nginx可以。<br/><br/>　　webbench 下载地址：<a href="http://blog.zyan.cc/post/288/" target="_blank">http://blog.zyan.cc/post/288/</a><br/><br/>　　注意：webbench 做压力测试时，该软件自身也会消耗CPU和内存资源，为了测试准确，请将 webbench 安装在别的服务器上。<br/><br/>　　测试结果：##### Nginx + PHP #####<br/><div class="quote"><div class="quote-title">引用</div><div class="quote-content">[root@localhost webbench-1.5]# webbench -c 100 -t 30 <a href="http://192.168.1.21/phpinfo.php" target="_blank">http://192.168.1.21/phpinfo.php</a><br/>Webbench - Simple Web Benchmark 1.5<br/>Copyright (c) Radim Kolar 1997-2004, GPL Open Source Software.<br/><br/>Benchmarking: GET <a href="http://192.168.1.21/phpinfo.php" target="_blank">http://192.168.1.21/phpinfo.php</a><br/>100 clients, running 30 sec.<br/><br/>Speed=102450 pages/min, 16490596 bytes/sec.<br/>Requests: 51225 susceed, 0 failed.<br/><br/>top - 14:06:13 up 27 days,&nbsp;&nbsp;2:25,&nbsp;&nbsp;2 users,&nbsp;&nbsp;load average: 14.57, 9.89, 6.51<br/>Tasks: 287 total,&nbsp;&nbsp; 4 running, 283 sleeping,&nbsp;&nbsp; 0 stopped,&nbsp;&nbsp; 0 zombie<br/>Cpu(s): 49.9% us,&nbsp;&nbsp;6.7% sy,&nbsp;&nbsp;0.0% ni, 41.4% id,&nbsp;&nbsp;1.1% wa,&nbsp;&nbsp;0.1% hi,&nbsp;&nbsp;0.8% si<br/>Mem:&nbsp;&nbsp; 6230016k total,&nbsp;&nbsp;2959468k used,&nbsp;&nbsp;3270548k free,&nbsp;&nbsp; 635992k buffers<br/>Swap:&nbsp;&nbsp;2031608k total,&nbsp;&nbsp;&nbsp;&nbsp; 3696k used,&nbsp;&nbsp;2027912k free,&nbsp;&nbsp;1231444k cached</div></div><br/><br/>　　测试结果：#####&nbsp;&nbsp;Apache + PHP #####<br/><div class="quote"><div class="quote-title">引用</div><div class="quote-content">[root@localhost webbench-1.5]# webbench -c 100 -t 30 <a href="http://192.168.1.27/phpinfo.php" target="_blank">http://192.168.1.27/phpinfo.php</a><br/>Webbench - Simple Web Benchmark 1.5<br/>Copyright (c) Radim Kolar 1997-2004, GPL Open Source Software.<br/><br/>Benchmarking: GET <a href="http://192.168.1.27/phpinfo.php" target="_blank">http://192.168.1.27/phpinfo.php</a><br/>100 clients, running 30 sec.<br/><br/>Speed=42184 pages/min, 31512914 bytes/sec.<br/>Requests: 21092 susceed, 0 failed.<br/><br/>top - 14:06:20 up 27 days,&nbsp;&nbsp;2:13,&nbsp;&nbsp;2 users,&nbsp;&nbsp;load average: 62.15, 26.36, 13.42<br/>Tasks: 318 total,&nbsp;&nbsp; 7 running, 310 sleeping,&nbsp;&nbsp; 0 stopped,&nbsp;&nbsp; 1 zombie<br/>Cpu(s): 80.4% us, 10.6% sy,&nbsp;&nbsp;0.0% ni,&nbsp;&nbsp;7.9% id,&nbsp;&nbsp;0.1% wa,&nbsp;&nbsp;0.1% hi,&nbsp;&nbsp;0.9% si<br/>Mem:&nbsp;&nbsp; 6230016k total,&nbsp;&nbsp;3075948k used,&nbsp;&nbsp;3154068k free,&nbsp;&nbsp; 379896k buffers<br/>Swap:&nbsp;&nbsp;2031608k total,&nbsp;&nbsp;&nbsp;&nbsp;12592k used,&nbsp;&nbsp;2019016k free,&nbsp;&nbsp;1117868k cached</div></div><br/><br/><hr/><br/>　　为什么Nginx的性能要比Apache高得多？这得益于Nginx使用了最新的epoll（Linux 2.6内核）和kqueue（freebsd）网络I/O模型，而Apache则使用的是传统的select模型。目前Linux下能够承受高并发访问的Squid、Memcached都采用的是epoll网络I/O模型。<br/><br/>　　处理大量的连接的读写，Apache所采用的select网络I/O模型非常低效。下面用一个比喻来解析Apache采用的select模型和Nginx采用的epoll模型进行之间的区别：<br/><br/>　　假设你在大学读书，住的宿舍楼有很多间房间，你的朋友要来找你。select版宿管大妈就会带着你的朋友挨个房间去找，直到找到你为止。而epoll版宿管大妈会先记下每位同学的房间号，你的朋友来时，只需告诉你的朋友你住在哪个房间即可，不用亲自带着你的朋友满大楼找人。如果来了10000个人，都要找自己住这栋楼的同学时，select版和epoll版宿管大妈，谁的效率更高，不言自明。同理，在高并发服务器中，轮询I/O是最耗时间的操作之一，select和epoll的性能谁的性能更高，同样十分明了。<br/><br/><hr/><br/>　　安装步骤：<br/>　　（系统要求：Linux 2.6+ 内核，本文中的Linux操作系统为CentOS 5.3，另在RedHat AS4上也安装成功）<br/><a name="entrymore"></a><br/>　　<strong>一、获取相关开源程序：</strong><br/>　　1、【适用CentOS操作系统】利用CentOS Linux系统自带的yum命令安装、升级所需的程序库（RedHat等其他Linux发行版可从安装光盘中找到这些程序库的RPM包，进行安装）：<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">sudo -s<br/>LANG=C<br/>yum -y install gcc gcc-c++ autoconf libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel libxml2 libxml2-devel zlib zlib-devel glibc glibc-devel glib2 glib2-devel bzip2 bzip2-devel ncurses ncurses-devel curl curl-devel e2fsprogs e2fsprogs-devel krb5 krb5-devel libidn libidn-devel openssl openssl-devel openldap openldap-devel nss_ldap openldap-clients openldap-servers</div><br/><br/>　　2、【适用RedHat操作系统】RedHat等其他Linux发行版可从安装光盘中找到这些程序库的RPM包（事先可通过类似“rpm -qa &#124; grep libjpeg”的命令查看所需的RPM包是否存在，通常是“xxx-devel”不存在，需要安装）。RedHat可以直接利用CentOS的RPM包安装，以下是RPM包下载网址：<br/>　　①、RedHat AS4 & CentOS 4<br/>　　<a href="http://mirrors.163.com/centos/4/os/i386/CentOS/RPMS/" target="_blank">http://mirrors.163.com/centos/4/os/i386/CentOS/RPMS/</a><br/>　　<a href="http://mirrors.163.com/centos/4/os/x86_64/CentOS/RPMS/" target="_blank">http://mirrors.163.com/centos/4/os/x86_64/CentOS/RPMS/</a><br/><br/>　　②、RedHat AS5 & CentOS 5<br/>　　<a href="http://mirrors.163.com/centos/5/os/i386/CentOS/" target="_blank">http://mirrors.163.com/centos/5/os/i386/CentOS/</a><br/>　　<a href="http://mirrors.163.com/centos/5/os/x86_64/CentOS/" target="_blank">http://mirrors.163.com/centos/5/os/x86_64/CentOS/</a><br/><br/>　　③、RPM包搜索网站<br/>　　<a href="http://rpm.pbone.net/" target="_blank">http://rpm.pbone.net/</a><br/>　　<a href="http://www.rpmfind.net/" target="_blank">http://www.rpmfind.net/</a><br/><br/>　　④、RedHat AS4 系统环境，通常情况下缺少的支持包安装：<br/>　　Ⅰ、i386 系统<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">wget <a href="http://blog.zyan.cc/soft/linux/nginx_php/rpm/i386/libjpeg-devel-6b-33.i386.rpm" target="_blank">http://blog.zyan.cc/soft/linux/nginx_php/rpm/i386/libjpeg-devel-6b-33.i386.rpm</a><br/>rpm -ivh libjpeg-devel-6b-33.i386.rpm<br/>wget <a href="http://blog.zyan.cc/soft/linux/nginx_php/rpm/i386/freetype-devel-2.1.9-1.i386.rpm" target="_blank">http://blog.zyan.cc/soft/linux/nginx_php/rpm/i386/freetype-devel-2.1.9-1.i386.rpm</a><br/>rpm -ivh freetype-devel-2.1.9-1.i386.rpm<br/>wget <a href="http://blog.zyan.cc/soft/linux/nginx_php/rpm/i386/libpng-devel-1.2.7-1.i386.rpm" target="_blank">http://blog.zyan.cc/soft/linux/nginx_php/rpm/i386/libpng-devel-1.2.7-1.i386.rpm</a><br/>rpm -ivh libpng-devel-1.2.7-1.i386.rpm</div><br/>　　Ⅱ、x86_64 系统<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">wget <a href="http://blog.zyan.cc/soft/linux/nginx_php/rpm/x86_64/libjpeg-devel-6b-33.x86_64.rpm" target="_blank">http://blog.zyan.cc/soft/linux/nginx_php/rpm/x86_64/libjpeg-devel-6b-33.x86_64.rpm</a><br/>rpm -ivh libjpeg-devel-6b-33.x86_64.rpm<br/>wget <a href="http://blog.zyan.cc/soft/linux/nginx_php/rpm/x86_64/freetype-devel-2.1.9-1.x86_64.rpm" target="_blank">http://blog.zyan.cc/soft/linux/nginx_php/rpm/x86_64/freetype-devel-2.1.9-1.x86_64.rpm</a><br/>rpm -ivh freetype-devel-2.1.9-1.x86_64.rpm<br/>wget <a href="http://blog.zyan.cc/soft/linux/nginx_php/rpm/x86_64/libpng-devel-1.2.7-1.x86_64.rpm" target="_blank">http://blog.zyan.cc/soft/linux/nginx_php/rpm/x86_64/libpng-devel-1.2.7-1.x86_64.rpm</a><br/>rpm -ivh libpng-devel-1.2.7-1.x86_64.rpm</div><br/><br/>　　3、【适用CentOS、RedHat及其它Linux操作系统】下载程序源码包：<br/>　　本文中提到的所有开源软件为截止到<span style="color: #FF0000;">2010年07月26日</span>的最新稳定版。<br/>　　①、从软件的官方网站下载：<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">mkdir -p /data0/software<br/>cd /data0/software<br/>wget <a href="http://sysoev.ru/nginx/nginx-0.8.46.tar.gz" target="_blank">http://sysoev.ru/nginx/nginx-0.8.46.tar.gz</a><br/>wget <a href="http://www.php.net/get/php-5.2.14.tar.gz/from/this/mirror" target="_blank">http://www.php.net/get/php-5.2.14.tar.gz/from/this/mirror</a><br/>wget <a href="http://php-fpm.org/downloads/php-5.2.14-fpm-0.5.14.diff.gz" target="_blank">http://php-fpm.org/downloads/php-5.2.14-fpm-0.5.14.diff.gz</a><br/>wget <a href="http://dev.mysql.com/get/Downloads/MySQL-5.5/mysql-5.5.3-m3.tar.gz/from/http://mysql.he.net/" target="_blank">http://dev.mysql.com/get/Downloads/MySQL-5.5/mysql-5.5.3-m3.tar.gz/from/http://mysql.he.net/</a><br/>wget <a href="http://ftp.gnu.org/pub/gnu/libiconv/libiconv-1.13.1.tar.gz" target="_blank">http://ftp.gnu.org/pub/gnu/libiconv/libiconv-1.13.1.tar.gz</a><br/>wget "http://downloads.sourceforge.net/mcrypt/libmcrypt-2.5.8.tar.gz?modtime=1171868460&big_mirror=0"<br/>wget "http://downloads.sourceforge.net/mcrypt/mcrypt-2.6.8.tar.gz?modtime=1194463373&big_mirror=0"<br/>wget <a href="http://pecl.php.net/get/memcache-2.2.5.tgz" target="_blank">http://pecl.php.net/get/memcache-2.2.5.tgz</a><br/>wget "http://downloads.sourceforge.net/mhash/mhash-0.9.9.9.tar.gz?modtime=1175740843&big_mirror=0"<br/>wget <a href="ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.10.tar.gz" target="_blank">ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.10.tar.gz</a><br/>wget <a href="http://bart.eaccelerator.net/source/0.9.6.1/eaccelerator-0.9.6.1.tar.bz2" target="_blank">http://bart.eaccelerator.net/source/0.9.6.1/eaccelerator-0.9.6.1.tar.bz2</a><br/>wget <a href="http://pecl.php.net/get/PDO_MYSQL-1.0.2.tgz" target="_blank">http://pecl.php.net/get/PDO_MYSQL-1.0.2.tgz</a><br/>wget <a href="http://blog.zyan.cc/soft/linux/nginx_php/imagick/ImageMagick.tar.gz" target="_blank">http://blog.zyan.cc/soft/linux/nginx_php/imagick/ImageMagick.tar.gz</a><br/>wget <a href="http://pecl.php.net/get/imagick-2.3.0.tgz" target="_blank">http://pecl.php.net/get/imagick-2.3.0.tgz</a></div><br/>　　②、从<a href="http://blog.zyan.cc" target="_blank">blog.zyan.cc</a>下载（比较稳定，只允许在本站，或者在Linux/Unix下通过Wget、Curl等命令下载以下软件）：<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">mkdir -p /data0/software<br/>cd /data0/software<br/>wget <a href="http://blog.zyan.cc/soft/linux/nginx_php/nginx/nginx-0.8.46.tar.gz" target="_blank">http://blog.zyan.cc/soft/linux/nginx_php/nginx/nginx-0.8.46.tar.gz</a><br/>wget <a href="http://blog.zyan.cc/soft/linux/nginx_php/php/php-5.2.14.tar.gz" target="_blank">http://blog.zyan.cc/soft/linux/nginx_php/php/php-5.2.14.tar.gz</a><br/>wget <a href="http://blog.zyan.cc/soft/linux/nginx_php/phpfpm/php-5.2.14-fpm-0.5.14.diff.gz" target="_blank">http://blog.zyan.cc/soft/linux/nginx_php/phpfpm/php-5.2.14-fpm-0.5.14.diff.gz</a><br/>wget <a href="http://blog.zyan.cc/soft/linux/nginx_php/mysql/mysql-5.5.3-m3.tar.gz" target="_blank">http://blog.zyan.cc/soft/linux/nginx_php/mysql/mysql-5.5.3-m3.tar.gz</a><br/>wget <a href="http://blog.zyan.cc/soft/linux/nginx_php/libiconv/libiconv-1.13.1.tar.gz" target="_blank">http://blog.zyan.cc/soft/linux/nginx_php/libiconv/libiconv-1.13.1.tar.gz</a><br/>wget <a href="http://blog.zyan.cc/soft/linux/nginx_php/mcrypt/libmcrypt-2.5.8.tar.gz" target="_blank">http://blog.zyan.cc/soft/linux/nginx_php/mcrypt/libmcrypt-2.5.8.tar.gz</a><br/>wget <a href="http://blog.zyan.cc/soft/linux/nginx_php/mcrypt/mcrypt-2.6.8.tar.gz" target="_blank">http://blog.zyan.cc/soft/linux/nginx_php/mcrypt/mcrypt-2.6.8.tar.gz</a><br/>wget <a href="http://blog.zyan.cc/soft/linux/nginx_php/memcache/memcache-2.2.5.tgz" target="_blank">http://blog.zyan.cc/soft/linux/nginx_php/memcache/memcache-2.2.5.tgz</a><br/>wget <a href="http://blog.zyan.cc/soft/linux/nginx_php/mhash/mhash-0.9.9.9.tar.gz" target="_blank">http://blog.zyan.cc/soft/linux/nginx_php/mhash/mhash-0.9.9.9.tar.gz</a><br/>wget <a href="http://blog.zyan.cc/soft/linux/nginx_php/pcre/pcre-8.10.tar.gz" target="_blank">http://blog.zyan.cc/soft/linux/nginx_php/pcre/pcre-8.10.tar.gz</a><br/>wget <a href="http://blog.zyan.cc/soft/linux/nginx_php/eaccelerator/eaccelerator-0.9.6.1.tar.bz2" target="_blank">http://blog.zyan.cc/soft/linux/nginx_php/eaccelerator/eaccelerator-0.9.6.1.tar.bz2</a><br/>wget <a href="http://blog.zyan.cc/soft/linux/nginx_php/pdo/PDO_MYSQL-1.0.2.tgz" target="_blank">http://blog.zyan.cc/soft/linux/nginx_php/pdo/PDO_MYSQL-1.0.2.tgz</a><br/>wget <a href="http://blog.zyan.cc/soft/linux/nginx_php/imagick/ImageMagick.tar.gz" target="_blank">http://blog.zyan.cc/soft/linux/nginx_php/imagick/ImageMagick.tar.gz</a><br/>wget <a href="http://blog.zyan.cc/soft/linux/nginx_php/imagick/imagick-2.3.0.tgz" target="_blank">http://blog.zyan.cc/soft/linux/nginx_php/imagick/imagick-2.3.0.tgz</a><br/></div><br/><hr/><br/>　　<strong>二、安装PHP 5.2.14（FastCGI模式）</strong><br/>　　1、编译安装PHP 5.2.14所需的支持库：<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">tar zxvf libiconv-1.13.1.tar.gz<br/>cd libiconv-1.13.1/<br/>./configure --prefix=/usr/local<br/>make<br/>make install<br/>cd ../<br/><br/>tar zxvf libmcrypt-2.5.8.tar.gz <br/>cd libmcrypt-2.5.8/<br/>./configure<br/>make<br/>make install<br/>/sbin/ldconfig<br/>cd libltdl/<br/>./configure --enable-ltdl-install<br/>make<br/>make install<br/>cd ../../<br/><br/>tar zxvf mhash-0.9.9.9.tar.gz<br/>cd mhash-0.9.9.9/<br/>./configure<br/>make<br/>make install<br/>cd ../<br/><br/>ln -s /usr/local/lib/libmcrypt.la /usr/lib/libmcrypt.la<br/>ln -s /usr/local/lib/libmcrypt.so /usr/lib/libmcrypt.so<br/>ln -s /usr/local/lib/libmcrypt.so.4 /usr/lib/libmcrypt.so.4<br/>ln -s /usr/local/lib/libmcrypt.so.4.4.8 /usr/lib/libmcrypt.so.4.4.8<br/>ln -s /usr/local/lib/libmhash.a /usr/lib/libmhash.a<br/>ln -s /usr/local/lib/libmhash.la /usr/lib/libmhash.la<br/>ln -s /usr/local/lib/libmhash.so /usr/lib/libmhash.so<br/>ln -s /usr/local/lib/libmhash.so.2 /usr/lib/libmhash.so.2<br/>ln -s /usr/local/lib/libmhash.so.2.0.1 /usr/lib/libmhash.so.2.0.1<br/>ln -s /usr/local/bin/libmcrypt-config /usr/bin/libmcrypt-config<br/><br/>tar zxvf mcrypt-2.6.8.tar.gz<br/>cd mcrypt-2.6.8/<br/>/sbin/ldconfig<br/>./configure<br/>make<br/>make install<br/>cd ../</div><br/><hr/><br/>　　2、编译安装MySQL 5.5.3-m3<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">/usr/sbin/groupadd mysql<br/>/usr/sbin/useradd -g mysql mysql<br/>tar zxvf mysql-5.5.3-m3.tar.gz<br/>cd mysql-5.5.3-m3/<br/>./configure --prefix=/usr/local/webserver/mysql/ --enable-assembler --with-extra-charsets=complex --enable-thread-safe-client --with-big-tables --with-readline --with-ssl --with-embedded-server --enable-local-infile --with-plugins=partition,innobase,myisammrg<br/>make && make install<br/>chmod +w /usr/local/webserver/mysql<br/>chown -R mysql:mysql /usr/local/webserver/mysql<br/>cd ../</div><br/><hr/><br/>　　附：以下为附加步骤，如果你想在这台服务器上运行MySQL数据库，则执行以下几步。如果你只是希望让PHP支持MySQL扩展库，能够连接其他服务器上的MySQL数据库，那么，以下两步无需执行。<br/><br/>　　①、创建MySQL数据库存放目录<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">mkdir -p /data0/mysql/3306/data/<br/>mkdir -p /data0/mysql/3306/binlog/<br/>mkdir -p /data0/mysql/3306/relaylog/<br/>chown -R mysql:mysql /data0/mysql/</div><br/><br/>　　②、以mysql用户帐号的身份建立数据表：<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">/usr/local/webserver/mysql/bin/mysql_install_db --basedir=/usr/local/webserver/mysql --datadir=/data0/mysql/3306/data --user=mysql</div><br/><br/>　　③、创建my.cnf配置文件：<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">vi /data0/mysql/3306/my.cnf</div><br/>　　输入以下内容：<br/><div class="quote"><div class="quote-title">引用</div><div class="quote-content">[client]<br/>character-set-server = utf8<br/>port&nbsp;&nbsp;&nbsp;&nbsp;= 3306<br/>socket&nbsp;&nbsp;= /tmp/mysql.sock<br/><br/>[mysqld]<br/>character-set-server = utf8<br/>replicate-ignore-db = mysql<br/>replicate-ignore-db = test<br/>replicate-ignore-db = information_schema<br/>user&nbsp;&nbsp;&nbsp;&nbsp;= mysql<br/>port&nbsp;&nbsp;&nbsp;&nbsp;= 3306<br/>socket&nbsp;&nbsp;= /tmp/mysql.sock<br/>basedir = /usr/local/webserver/mysql<br/>datadir = /data0/mysql/3306/data<br/>log-error = /data0/mysql/3306/mysql_error.log<br/>pid-file = /data0/mysql/3306/mysql.pid<br/>open_files_limit&nbsp;&nbsp;&nbsp;&nbsp;= 10240<br/>back_log = 600<br/>max_connections = 5000<br/>max_connect_errors = 6000<br/>table_cache = 614<br/>external-locking = FALSE<br/>max_allowed_packet = 32M<br/>sort_buffer_size = 1M<br/>join_buffer_size = 1M<br/>thread_cache_size = 300<br/>#thread_concurrency = 8<br/>query_cache_size = 512M<br/>query_cache_limit = 2M<br/>query_cache_min_res_unit = 2k<br/>default-storage-engine = MyISAM<br/>thread_stack = 192K<br/>transaction_isolation = READ-COMMITTED<br/>tmp_table_size = 246M<br/>max_heap_table_size = 246M<br/>long_query_time = 3<br/>log-slave-updates<br/>log-bin = /data0/mysql/3306/binlog/binlog<br/>binlog_cache_size = 4M<br/>binlog_format = MIXED<br/>max_binlog_cache_size = 8M<br/>max_binlog_size = 1G<br/>relay-log-index = /data0/mysql/3306/relaylog/relaylog<br/>relay-log-info-file = /data0/mysql/3306/relaylog/relaylog<br/>relay-log = /data0/mysql/3306/relaylog/relaylog<br/>expire_logs_days = 30<br/>key_buffer_size = 256M<br/>read_buffer_size = 1M<br/>read_rnd_buffer_size = 16M<br/>bulk_insert_buffer_size = 64M<br/>myisam_sort_buffer_size = 128M<br/>myisam_max_sort_file_size = 10G<br/>myisam_repair_threads = 1<br/>myisam_recover<br/><br/>interactive_timeout = 120<br/>wait_timeout = 120<br/><br/>skip-name-resolve<br/>#master-connect-retry = 10<br/>slave-skip-errors = 1032,1062,126,1114,1146,1048,1396<br/><br/>#master-host&nbsp;&nbsp;&nbsp;&nbsp; =&nbsp;&nbsp; 192.168.1.2<br/>#master-user&nbsp;&nbsp;&nbsp;&nbsp; =&nbsp;&nbsp; username<br/>#master-password =&nbsp;&nbsp; password<br/>#master-port&nbsp;&nbsp;&nbsp;&nbsp; =&nbsp;&nbsp;3306<br/><br/>server-id = 1<br/><br/>innodb_additional_mem_pool_size = 16M<br/>innodb_buffer_pool_size = 512M<br/>innodb_data_file_path = ibdata1:256M:autoextend<br/>innodb_file_io_threads = 4<br/>innodb_thread_concurrency = 8<br/>innodb_flush_log_at_trx_commit = 2<br/>innodb_log_buffer_size = 16M<br/>innodb_log_file_size = 128M<br/>innodb_log_files_in_group = 3<br/>innodb_max_dirty_pages_pct = 90<br/>innodb_lock_wait_timeout = 120<br/>innodb_file_per_table = 0<br/><br/>#log-slow-queries = /data0/mysql/3306/slow.log<br/>#long_query_time = 10<br/><br/>[mysqldump]<br/>quick<br/>max_allowed_packet = 32M</div></div><br/><br/>　　④、创建管理MySQL数据库的shell脚本：<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">vi /data0/mysql/3306/mysql</div><br/>　　输入以下内容（这里的用户名admin和密码12345678接下来的步骤会创建）：<br/><div class="code">#!/bin/sh<br/><br/>mysql_port=3306<br/>mysql_username=&quot;admin&quot;<br/>mysql_password=&quot;12345678&quot;<br/><br/>function_start_mysql()<br/>&#123;<br/>&nbsp;&nbsp;&nbsp;&nbsp;printf &quot;Starting MySQL...&#92;n&quot;<br/>&nbsp;&nbsp;&nbsp;&nbsp;/bin/sh /usr/local/webserver/mysql/bin/mysqld_safe --defaults-file=/data0/mysql/$&#123;mysql_port&#125;/my.cnf 2&gt;&amp;1 &gt; /dev/null &amp;<br/>&#125;<br/><br/>function_stop_mysql()<br/>&#123;<br/>&nbsp;&nbsp;&nbsp;&nbsp;printf &quot;Stoping MySQL...&#92;n&quot;<br/>&nbsp;&nbsp;&nbsp;&nbsp;/usr/local/webserver/mysql/bin/mysqladmin -u $&#123;mysql_username&#125; -p$&#123;mysql_password&#125; -S /tmp/mysql.sock shutdown<br/>&#125;<br/><br/>function_restart_mysql()<br/>&#123;<br/>&nbsp;&nbsp;&nbsp;&nbsp;printf &quot;Restarting MySQL...&#92;n&quot;<br/>&nbsp;&nbsp;&nbsp;&nbsp;function_stop_mysql<br/>&nbsp;&nbsp;&nbsp;&nbsp;sleep 5<br/>&nbsp;&nbsp;&nbsp;&nbsp;function_start_mysql<br/>&#125;<br/><br/>function_kill_mysql()<br/>&#123;<br/>&nbsp;&nbsp;&nbsp;&nbsp;kill -9 $(ps -ef &amp;#124; grep &#039;bin/mysqld_safe&#039; &amp;#124; grep $&#123;mysql_port&#125; &amp;#124; awk &#039;&#123;printf $2&#125;&#039;)<br/>&nbsp;&nbsp;&nbsp;&nbsp;kill -9 $(ps -ef &amp;#124; grep &#039;libexec/mysqld&#039; &amp;#124; grep $&#123;mysql_port&#125; &amp;#124; awk &#039;&#123;printf $2&#125;&#039;)<br/>&#125;<br/><br/>if &#91; &quot;$1&quot; = &quot;start&quot; &#93;; then<br/>&nbsp;&nbsp;&nbsp;&nbsp;function_start_mysql<br/>elif &#91; &quot;$1&quot; = &quot;stop&quot; &#93;; then<br/>&nbsp;&nbsp;&nbsp;&nbsp;function_stop_mysql<br/>elif &#91; &quot;$1&quot; = &quot;restart&quot; &#93;; then<br/>function_restart_mysql<br/>elif &#91; &quot;$1&quot; = &quot;kill&quot; &#93;; then<br/>function_kill_mysql<br/>else<br/>&nbsp;&nbsp;&nbsp;&nbsp;printf &quot;Usage: /data0/mysql/$&#123;mysql_port&#125;/mysql &#123;start&amp;#124;stop&amp;#124;restart&amp;#124;kill&#125;&#92;n&quot;<br/>fi</div><br/>　　⑤、赋予shell脚本可执行权限：<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">chmod +x /data0/mysql/3306/mysql</div><br/><br/>　　⑥、启动MySQL：<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">/data0/mysql/3306/mysql start</div><br/><br/>　　⑦、通过命令行登录管理MySQL服务器（提示输入密码时直接回车）：<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">/usr/local/webserver/mysql/bin/mysql -u root -p -S /tmp/mysql.sock</div><br/><br/>　　⑧、输入以下SQL语句，创建一个具有root权限的用户（admin）和密码（12345678）：<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">GRANT ALL PRIVILEGES ON *.* TO 'admin'@'localhost' IDENTIFIED BY '12345678';<br/>GRANT ALL PRIVILEGES ON *.* TO 'admin'@'127.0.0.1' IDENTIFIED BY '12345678';</div><br/><br/>　　⑨、（可选）停止MySQL：<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">/data0/mysql/3306/mysql stop</div><br/><hr/><br/>　　3、编译安装PHP（FastCGI模式）<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">tar zxvf php-5.2.14.tar.gz<br/>gzip -cd php-5.2.14-fpm-0.5.14.diff.gz &#124; patch -d php-5.2.14 -p1<br/>cd php-5.2.14/<br/>./configure --prefix=/usr/local/webserver/php --with-config-file-path=/usr/local/webserver/php/etc --with-mysql=/usr/local/webserver/mysql --with-mysqli=/usr/local/webserver/mysql/bin/mysql_config --with-iconv-dir=/usr/local --with-freetype-dir --with-jpeg-dir --with-png-dir --with-zlib --with-libxml-dir=/usr --enable-xml --disable-rpath --enable-discard-path --enable-safe-mode --enable-bcmath --enable-shmop --enable-sysvsem --enable-inline-optimization --with-curl --with-curlwrappers --enable-mbregex --enable-fastcgi --enable-fpm --enable-force-cgi-redirect --enable-mbstring --with-mcrypt --with-gd --enable-gd-native-ttf --with-openssl --with-mhash --enable-pcntl --enable-sockets --with-ldap --with-ldap-sasl --with-xmlrpc --enable-zip --enable-soap<br/>make ZEND_EXTRA_LIBS='-liconv'<br/>make install<br/>cp php.ini-dist /usr/local/webserver/php/etc/php.ini<br/>cd ../</div><br/><hr/><br/>　　4、编译安装PHP5扩展模块<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">tar zxvf memcache-2.2.5.tgz<br/>cd memcache-2.2.5/<br/>/usr/local/webserver/php/bin/phpize<br/>./configure --with-php-config=/usr/local/webserver/php/bin/php-config<br/>make<br/>make install<br/>cd ../<br/><br/>tar jxvf eaccelerator-0.9.6.1.tar.bz2<br/>cd eaccelerator-0.9.6.1/<br/>/usr/local/webserver/php/bin/phpize<br/>./configure --enable-eaccelerator=shared --with-php-config=/usr/local/webserver/php/bin/php-config<br/>make<br/>make install<br/>cd ../<br/><br/>tar zxvf PDO_MYSQL-1.0.2.tgz<br/>cd PDO_MYSQL-1.0.2/<br/>/usr/local/webserver/php/bin/phpize<br/>./configure --with-php-config=/usr/local/webserver/php/bin/php-config --with-pdo-mysql=/usr/local/webserver/mysql<br/>make<br/>make install<br/>cd ../<br/><br/>tar zxvf ImageMagick.tar.gz<br/>cd ImageMagick-6.5.1-2/<br/>./configure<br/>make<br/>make install<br/>cd ../<br/><br/>tar zxvf imagick-2.3.0.tgz<br/>cd imagick-2.3.0/<br/>/usr/local/webserver/php/bin/phpize<br/>./configure --with-php-config=/usr/local/webserver/php/bin/php-config<br/>make<br/>make install<br/>cd ../<br/></div><br/><br/>　　5、修改php.ini文件<br/>　　<strong>手工修改：</strong>查找/usr/local/webserver/php/etc/php.ini中的extension_dir = "./"<br/>　　修改为extension_dir = "/usr/local/webserver/php/lib/php/extensions/no-debug-non-zts-20060613/"<br/>　　并在此行后增加以下几行，然后保存：<br/>　　extension = "memcache.so"<br/>　　extension = "pdo_mysql.so"<br/>　　extension = "imagick.so"<br/><br/>　　再查找output_buffering = Off<br/>　　修改为output_buffering = On<br/><br/>　　再查找; cgi.fix_pathinfo=0<br/>　　修改为cgi.fix_pathinfo=0，防止Nginx文件类型错误解析漏洞。<br/><br/>　　<strong>自动修改：</strong>若嫌手工修改麻烦，可执行以下shell命令，自动完成对php.ini文件的修改：<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">sed -i 's#extension_dir = "./"#extension_dir = "/usr/local/webserver/php/lib/php/extensions/no-debug-non-zts-20060613/"&#92;nextension = "memcache.so"&#92;nextension = "pdo_mysql.so"&#92;nextension = "imagick.so"&#92;n#' /usr/local/webserver/php/etc/php.ini<br/>sed -i 's#output_buffering = Off#output_buffering = On#' /usr/local/webserver/php/etc/php.ini<br/>sed -i "s#; always_populate_raw_post_data = On#always_populate_raw_post_data = On#g" /usr/local/webserver/php/etc/php.ini<br/>sed -i "s#; cgi.fix_pathinfo=0#cgi.fix_pathinfo=0#g" /usr/local/webserver/php/etc/php.ini</div><br/><br/>　　6、配置eAccelerator加速PHP：<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">mkdir -p /usr/local/webserver/eaccelerator_cache<br/>vi /usr/local/webserver/php/etc/php.ini</div><br/>　　按shift+g键跳到配置文件的最末尾，加上以下配置信息：<br/><div class="quote"><div class="quote-title">引用</div><div class="quote-content">[eaccelerator]<br/>zend_extension="/usr/local/webserver/php/lib/php/extensions/no-debug-non-zts-20060613/eaccelerator.so"<br/>eaccelerator.shm_size="64"<br/>eaccelerator.cache_dir="/usr/local/webserver/eaccelerator_cache"<br/>eaccelerator.enable="1"<br/>eaccelerator.optimizer="1"<br/>eaccelerator.check_mtime="1"<br/>eaccelerator.debug="0"<br/>eaccelerator.filter=""<br/>eaccelerator.shm_max="0"<br/>eaccelerator.shm_ttl="3600"<br/>eaccelerator.shm_prune_period="3600"<br/>eaccelerator.shm_only="0"<br/>eaccelerator.compress="1"<br/>eaccelerator.compress_level="9"</div></div><br/><br/><hr/><br/>　　7、创建www用户和组，以及供blog.zyan.cc和<a href="http://www.zyan.cc" target="_blank">www.zyan.cc</a>两个虚拟主机使用的目录：<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">/usr/sbin/groupadd www<br/>/usr/sbin/useradd -g www www<br/>mkdir -p /data0/htdocs/blog<br/>chmod +w /data0/htdocs/blog<br/>chown -R www:www /data0/htdocs/blog<br/>mkdir -p /data0/htdocs/www<br/>chmod +w /data0/htdocs/www<br/>chown -R www:www /data0/htdocs/www</div><br/><br/>　　8、创建php-fpm配置文件（php-fpm是为PHP打的一个FastCGI管理补丁，可以平滑变更php.ini配置而无需重启php-cgi）：<br/>　　在/usr/local/webserver/php/etc/目录中创建php-fpm.conf文件：<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">rm -f /usr/local/webserver/php/etc/php-fpm.conf<br/>vi /usr/local/webserver/php/etc/php-fpm.conf</div><br/>　　输入以下内容（如果您安装 Nginx + PHP 用于程序调试，请将以下的&lt;value name=&quot;display_errors&quot;&gt;0&lt;/value&gt;改为&lt;value name=&quot;display_errors&quot;&gt;1&lt;/value&gt;，以便显示PHP错误信息，否则，Nginx 会报状态为500的空白错误页）：<div class="code">&lt;?xml version=&quot;1.0&quot; ?&gt;<br/>&lt;configuration&gt;<br/><br/>&nbsp;&nbsp;All relative paths in this config are relative to php&#039;s install prefix<br/><br/>&nbsp;&nbsp;&lt;section name=&quot;global_options&quot;&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;Pid file<br/>&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;pid_file&quot;&gt;/usr/local/webserver/php/logs/php-fpm.pid&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;Error log file<br/>&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;error_log&quot;&gt;/usr/local/webserver/php/logs/php-fpm.log&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;Log level<br/>&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;log_level&quot;&gt;notice&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;When this amount of php processes exited with SIGSEGV or SIGBUS ...<br/>&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;emergency_restart_threshold&quot;&gt;10&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;... in a less than this interval of time, a graceful restart will be initiated.<br/>&nbsp;&nbsp;&nbsp;&nbsp;Useful to work around accidental curruptions in accelerator&#039;s shared memory.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;emergency_restart_interval&quot;&gt;1m&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;Time limit on waiting child&#039;s reaction on signals from master<br/>&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;process_control_timeout&quot;&gt;5s&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;Set to &#039;no&#039; to debug fpm<br/>&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;daemonize&quot;&gt;yes&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&lt;/section&gt;<br/><br/>&nbsp;&nbsp;&lt;workers&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&lt;section name=&quot;pool&quot;&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Name of pool. Used in logs and stats.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;name&quot;&gt;default&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Address to accept fastcgi requests on.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Valid syntax is &#039;ip.ad.re.ss:port&#039; or just &#039;port&#039; or &#039;/path/to/unix/socket&#039;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;listen_address&quot;&gt;127.0.0.1:9000&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;listen_options&quot;&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set listen(2) backlog<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;backlog&quot;&gt;-1&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set permissions for unix socket, if one used.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;In Linux read/write permissions must be set in order to allow connections from web server.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Many BSD-derrived systems allow connections regardless of permissions.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;owner&quot;&gt;&lt;/value&gt;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;group&quot;&gt;&lt;/value&gt;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;mode&quot;&gt;0666&lt;/value&gt;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Additional php.ini defines, specific to this pool of workers.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;php_defines&quot;&gt;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;sendmail_path&quot;&gt;/usr/sbin/sendmail -t -i&lt;/value&gt;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;display_errors&quot;&gt;0&lt;/value&gt;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Unix user of processes<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;user&quot;&gt;www&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Unix group of processes<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;group&quot;&gt;www&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Process manager settings<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;pm&quot;&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sets style of controling worker process count.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Valid values are &#039;static&#039; and &#039;apache-like&#039;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;style&quot;&gt;static&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sets the limit on the number of simultaneous requests that will be served.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Equivalent to Apache MaxClients directive.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Equivalent to PHP_FCGI_CHILDREN environment in original php.fcgi<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Used with any pm_style.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;max_children&quot;&gt;128&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Settings group for &#039;apache-like&#039; pm style<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;apache_like&quot;&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sets the number of server processes created on startup.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Used only when &#039;apache-like&#039; pm_style is selected<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;StartServers&quot;&gt;20&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sets the desired minimum number of idle server processes.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Used only when &#039;apache-like&#039; pm_style is selected<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;MinSpareServers&quot;&gt;5&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sets the desired maximum number of idle server processes.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Used only when &#039;apache-like&#039; pm_style is selected<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;MaxSpareServers&quot;&gt;35&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The timeout (in seconds) for serving a single request after which the worker process will be terminated<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Should be used when &#039;max_execution_time&#039; ini option does not stop script execution for some reason<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#039;0s&#039; means &#039;off&#039;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;request_terminate_timeout&quot;&gt;0s&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The timeout (in seconds) for serving of single request after which a php backtrace will be dumped to slow.log file<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#039;0s&#039; means &#039;off&#039;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;request_slowlog_timeout&quot;&gt;0s&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The log file for slow requests<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;slowlog&quot;&gt;logs/slow.log&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set open file desc rlimit<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;rlimit_files&quot;&gt;65535&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set max core size rlimit<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;rlimit_core&quot;&gt;0&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Chroot to this directory at the start, absolute path<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;chroot&quot;&gt;&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Chdir to this directory at the start, absolute path<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;chdir&quot;&gt;&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Redirect workers&#039; stdout and stderr into main error log.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If not set, they will be redirected to /dev/null, according to FastCGI specs<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;catch_workers_output&quot;&gt;yes&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;How much requests each process should execute before respawn.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Useful to work around memory leaks in 3rd party libraries.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;For endless request processing please specify 0<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Equivalent to PHP_FCGI_MAX_REQUESTS<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;max_requests&quot;&gt;1024&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Comma separated list of ipv4 addresses of FastCGI clients that allowed to connect.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Equivalent to FCGI_WEB_SERVER_ADDRS environment in original php.fcgi (5.2.2+)<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Makes sense only with AF_INET listening socket.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;allowed_clients&quot;&gt;127.0.0.1&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Pass environment variables like LD_LIBRARY_PATH<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;All $VARIABLEs are taken from current environment<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;environment&quot;&gt;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;HOSTNAME&quot;&gt;$HOSTNAME&lt;/value&gt;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;PATH&quot;&gt;/usr/local/bin:/usr/bin:/bin&lt;/value&gt;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;TMP&quot;&gt;/tmp&lt;/value&gt;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;TMPDIR&quot;&gt;/tmp&lt;/value&gt;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;TEMP&quot;&gt;/tmp&lt;/value&gt;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;OSTYPE&quot;&gt;$OSTYPE&lt;/value&gt;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;MACHTYPE&quot;&gt;$MACHTYPE&lt;/value&gt;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value name=&quot;MALLOC_CHECK_&quot;&gt;2&lt;/value&gt;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/value&gt;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&lt;/section&gt;<br/><br/>&nbsp;&nbsp;&lt;/workers&gt;<br/><br/>&lt;/configuration&gt;</div>　　9、启动php-cgi进程，监听127.0.0.1的9000端口，进程数为128（如果服务器内存小于3GB，可以只开启64个进程），用户为www：<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">ulimit -SHn 65535<br/>/usr/local/webserver/php/sbin/php-fpm start</div><br/>　　注：/usr/local/webserver/php/sbin/php-fpm还有其他参数，包括：start&#124;stop&#124;quit&#124;restart&#124;reload&#124;logrotate，修改php.ini后不重启php-cgi，重新加载配置文件使用reload。<br/><br/><hr/><br/>　　<strong>三、安装Nginx 0.8.46</strong><br/>　　1、安装Nginx所需的pcre库：<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">tar zxvf pcre-8.10.tar.gz<br/>cd pcre-8.10/<br/>./configure<br/>make && make install<br/>cd ../</div><br/><br/>　　2、安装Nginx<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">tar zxvf nginx-0.8.46.tar.gz<br/>cd nginx-0.8.46/<br/>./configure --user=www --group=www --prefix=/usr/local/webserver/nginx --with-http_stub_status_module --with-http_ssl_module<br/>make && make install<br/>cd ../</div><br/><br/>　　3、创建Nginx日志目录<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">mkdir -p /data1/logs<br/>chmod +w /data1/logs<br/>chown -R www:www /data1/logs</div><br/><br/>　　4、创建Nginx配置文件<br/>　　①、在/usr/local/webserver/nginx/conf/目录中创建nginx.conf文件：<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">rm -f /usr/local/webserver/nginx/conf/nginx.conf<br/>vi /usr/local/webserver/nginx/conf/nginx.conf</div><br/>　　输入以下内容：<br/><div class="quote"><div class="quote-title">引用</div><div class="quote-content">user&nbsp;&nbsp;www www;<br/><br/>worker_processes 8;<br/><br/>error_log&nbsp;&nbsp;/data1/logs/nginx_error.log&nbsp;&nbsp;crit;<br/><br/>pid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/usr/local/webserver/nginx/nginx.pid;<br/><br/>#Specifies the value for maximum file descriptors that can be opened by this process. <br/>worker_rlimit_nofile 65535;<br/><br/>events <br/>&#123;<br/>&nbsp;&nbsp;use epoll;<br/>&nbsp;&nbsp;worker_connections 65535;<br/>&#125;<br/><br/>http <br/>&#123;<br/>&nbsp;&nbsp;include&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mime.types;<br/>&nbsp;&nbsp;default_type&nbsp;&nbsp;application/octet-stream;<br/><br/>&nbsp;&nbsp;#charset&nbsp;&nbsp;gb2312;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>&nbsp;&nbsp;server_names_hash_bucket_size 128;<br/>&nbsp;&nbsp;client_header_buffer_size 32k;<br/>&nbsp;&nbsp;large_client_header_buffers 4 32k;<br/>&nbsp;&nbsp;client_max_body_size 8m;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>&nbsp;&nbsp;sendfile on;<br/>&nbsp;&nbsp;tcp_nopush&nbsp;&nbsp;&nbsp;&nbsp; on;<br/><br/>&nbsp;&nbsp;keepalive_timeout 60;<br/><br/>&nbsp;&nbsp;tcp_nodelay on;<br/><br/>&nbsp;&nbsp;fastcgi_connect_timeout 300;<br/>&nbsp;&nbsp;fastcgi_send_timeout 300;<br/>&nbsp;&nbsp;fastcgi_read_timeout 300;<br/>&nbsp;&nbsp;fastcgi_buffer_size 64k;<br/>&nbsp;&nbsp;fastcgi_buffers 4 64k;<br/>&nbsp;&nbsp;fastcgi_busy_buffers_size 128k;<br/>&nbsp;&nbsp;fastcgi_temp_file_write_size 128k;<br/><br/>&nbsp;&nbsp;gzip on;<br/>&nbsp;&nbsp;gzip_min_length&nbsp;&nbsp;1k;<br/>&nbsp;&nbsp;gzip_buffers&nbsp;&nbsp;&nbsp;&nbsp; 4 16k;<br/>&nbsp;&nbsp;gzip_http_version 1.0;<br/>&nbsp;&nbsp;gzip_comp_level 2;<br/>&nbsp;&nbsp;gzip_types&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; text/plain application/x-javascript text/css application/xml;<br/>&nbsp;&nbsp;gzip_vary on;<br/><br/>&nbsp;&nbsp;#limit_zone&nbsp;&nbsp;crawler&nbsp;&nbsp;$binary_remote_addr&nbsp;&nbsp;10m;<br/><br/>&nbsp;&nbsp;server<br/>&nbsp;&nbsp;&#123;<br/>&nbsp;&nbsp;&nbsp;&nbsp;listen&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 80;<br/>&nbsp;&nbsp;&nbsp;&nbsp;server_name&nbsp;&nbsp;blog.zyan.cc;<br/>&nbsp;&nbsp;&nbsp;&nbsp;index index.html index.htm index.php;<br/>&nbsp;&nbsp;&nbsp;&nbsp;root&nbsp;&nbsp;/data0/htdocs/blog;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;#limit_conn&nbsp;&nbsp; crawler&nbsp;&nbsp;20;&nbsp;&nbsp;&nbsp;&nbsp;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br/>&nbsp;&nbsp;&nbsp;&nbsp;location ~ .*&#92;.(php&#124;php5)?$<br/>&nbsp;&nbsp;&nbsp;&nbsp;&#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#fastcgi_pass&nbsp;&nbsp;unix:/tmp/php-cgi.sock;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_pass&nbsp;&nbsp;127.0.0.1:9000;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_index index.php;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;include fcgi.conf;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&#125;<br/>&nbsp;&nbsp;&nbsp;&nbsp;<br/>&nbsp;&nbsp;&nbsp;&nbsp;location ~ .*&#92;.(gif&#124;jpg&#124;jpeg&#124;png&#124;bmp&#124;swf)$<br/>&nbsp;&nbsp;&nbsp;&nbsp;&#123;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expires&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;30d;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&#125;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;location ~ .*&#92;.(js&#124;css)?$<br/>&nbsp;&nbsp;&nbsp;&nbsp;&#123;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expires&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1h;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&#125;&nbsp;&nbsp;&nbsp;&nbsp;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;log_format&nbsp;&nbsp;access&nbsp;&nbsp;'$remote_addr - $remote_user [$time_local] "$request" '<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'$status $body_bytes_sent "$http_referer" '<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'"$http_user_agent" $http_x_forwarded_for';<br/>&nbsp;&nbsp;&nbsp;&nbsp;access_log&nbsp;&nbsp;/data1/logs/access.log&nbsp;&nbsp;access;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#125;<br/><br/>&nbsp;&nbsp;server<br/>&nbsp;&nbsp;&#123;<br/>&nbsp;&nbsp;&nbsp;&nbsp;listen&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 80;<br/>&nbsp;&nbsp;&nbsp;&nbsp;server_name&nbsp;&nbsp;<a href="http://www.zyan.cc;" target="_blank">www.zyan.cc;</a><br/>&nbsp;&nbsp;&nbsp;&nbsp;index index.html index.htm index.php;<br/>&nbsp;&nbsp;&nbsp;&nbsp;root&nbsp;&nbsp;/data0/htdocs/www;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;location ~ .*&#92;.(php&#124;php5)?$<br/>&nbsp;&nbsp;&nbsp;&nbsp;&#123;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#fastcgi_pass&nbsp;&nbsp;unix:/tmp/php-cgi.sock;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_pass&nbsp;&nbsp;127.0.0.1:9000;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_index index.php;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;include fcgi.conf;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&#125;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;log_format&nbsp;&nbsp;wwwlogs&nbsp;&nbsp;'$remote_addr - $remote_user [$time_local] "$request" '<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '$status $body_bytes_sent "$http_referer" '<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '"$http_user_agent" $http_x_forwarded_for';<br/>&nbsp;&nbsp;&nbsp;&nbsp;access_log&nbsp;&nbsp;/data1/logs/wwwlogs.log&nbsp;&nbsp;wwwlogs;<br/>&nbsp;&nbsp;&#125;<br/><br/>&nbsp;&nbsp;server<br/>&nbsp;&nbsp;&#123;<br/>&nbsp;&nbsp;&nbsp;&nbsp;listen&nbsp;&nbsp;80;<br/>&nbsp;&nbsp;&nbsp;&nbsp;server_name&nbsp;&nbsp;status.blog.zyan.cc;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;location / &#123;<br/>&nbsp;&nbsp;&nbsp;&nbsp;stub_status on;<br/>&nbsp;&nbsp;&nbsp;&nbsp;access_log&nbsp;&nbsp; off;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&#125;<br/>&nbsp;&nbsp;&#125;<br/>&#125;</div></div><br/><br/>　　②、在/usr/local/webserver/nginx/conf/目录中创建fcgi.conf文件：<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">vi /usr/local/webserver/nginx/conf/fcgi.conf</div><br/>　　输入以下内容：<br/><div class="quote"><div class="quote-title">引用</div><div class="quote-content">fastcgi_param&nbsp;&nbsp;GATEWAY_INTERFACE&nbsp;&nbsp;CGI/1.1;<br/>fastcgi_param&nbsp;&nbsp;SERVER_SOFTWARE&nbsp;&nbsp;&nbsp;&nbsp;nginx;<br/><br/>fastcgi_param&nbsp;&nbsp;QUERY_STRING&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $query_string;<br/>fastcgi_param&nbsp;&nbsp;REQUEST_METHOD&nbsp;&nbsp;&nbsp;&nbsp; $request_method;<br/>fastcgi_param&nbsp;&nbsp;CONTENT_TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $content_type;<br/>fastcgi_param&nbsp;&nbsp;CONTENT_LENGTH&nbsp;&nbsp;&nbsp;&nbsp; $content_length;<br/><br/>fastcgi_param&nbsp;&nbsp;SCRIPT_FILENAME&nbsp;&nbsp;&nbsp;&nbsp;$document_root$fastcgi_script_name;<br/>fastcgi_param&nbsp;&nbsp;SCRIPT_NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fastcgi_script_name;<br/>fastcgi_param&nbsp;&nbsp;REQUEST_URI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$request_uri;<br/>fastcgi_param&nbsp;&nbsp;DOCUMENT_URI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $document_uri;<br/>fastcgi_param&nbsp;&nbsp;DOCUMENT_ROOT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$document_root;<br/>fastcgi_param&nbsp;&nbsp;SERVER_PROTOCOL&nbsp;&nbsp;&nbsp;&nbsp;$server_protocol;<br/><br/>fastcgi_param&nbsp;&nbsp;REMOTE_ADDR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$remote_addr;<br/>fastcgi_param&nbsp;&nbsp;REMOTE_PORT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$remote_port;<br/>fastcgi_param&nbsp;&nbsp;SERVER_ADDR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$server_addr;<br/>fastcgi_param&nbsp;&nbsp;SERVER_PORT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$server_port;<br/>fastcgi_param&nbsp;&nbsp;SERVER_NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$server_name;<br/><br/># PHP only, required if PHP was built with --enable-force-cgi-redirect<br/>fastcgi_param&nbsp;&nbsp;REDIRECT_STATUS&nbsp;&nbsp;&nbsp;&nbsp;200;</div></div><br/><br/>　　5、启动Nginx<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">ulimit -SHn 65535<br/>/usr/local/webserver/nginx/sbin/nginx</div><br/><hr/><br/>　　<strong>四、配置开机自动启动Nginx + PHP</strong><br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">vi /etc/rc.local</div><br/>　　在末尾增加以下内容：<br/><div class="quote"><div class="quote-title">引用</div><div class="quote-content">ulimit -SHn 65535<br/>/usr/local/webserver/php/sbin/php-fpm start<br/>/usr/local/webserver/nginx/sbin/nginx</div></div><br/><hr/><br/>　　<strong>五、优化Linux内核参数</strong><br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">vi /etc/sysctl.conf</div><br/>　　在末尾增加以下内容：<br/><div class="quote"><div class="quote-title">引用</div><div class="quote-content"># Add<br/>net.ipv4.tcp_max_syn_backlog = 65536<br/>net.core.netdev_max_backlog =&nbsp;&nbsp;32768<br/>net.core.somaxconn = 32768<br/><br/>net.core.wmem_default = 8388608<br/>net.core.rmem_default = 8388608<br/>net.core.rmem_max = 16777216<br/>net.core.wmem_max = 16777216<br/><br/>net.ipv4.tcp_timestamps = 0<br/>net.ipv4.tcp_synack_retries = 2<br/>net.ipv4.tcp_syn_retries = 2<br/><br/>net.ipv4.tcp_tw_recycle = 1<br/>#net.ipv4.tcp_tw_len = 1<br/>net.ipv4.tcp_tw_reuse = 1<br/><br/>net.ipv4.tcp_mem = 94500000 915000000 927000000<br/>net.ipv4.tcp_max_orphans = 3276800<br/><br/>#net.ipv4.tcp_fin_timeout = 30<br/>#net.ipv4.tcp_keepalive_time = 120<br/>net.ipv4.ip_local_port_range = 1024&nbsp;&nbsp;65535</div></div><br/><br/>　　使配置立即生效：<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">/sbin/sysctl -p</div><br/><hr/><br/>　　<strong>六、在不停止Nginx服务的情况下平滑变更Nginx配置</strong><br/>　　1、修改/usr/local/webserver/nginx/conf/nginx.conf配置文件后，请执行以下命令检查配置文件是否正确：<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">/usr/local/webserver/nginx/sbin/nginx -t</div><br/>　　如果屏幕显示以下两行信息，说明配置文件正确：<br/>　　<span style="color: #008000;">the configuration file /usr/local/webserver/nginx/conf/nginx.conf syntax is ok<br/>　　the configuration file /usr/local/webserver/nginx/conf/nginx.conf was tested successfully</span><br/><br/>　　2、平滑重启：<br/>　　①、对于Nginx 0.8.x版本，现在平滑重启Nginx配置非常简单，执行以下命令即可：<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">/usr/local/webserver/nginx/sbin/nginx -s reload</div><br/><br/>　　②、对于Nginx 0.8.x之前的版本，平滑重启稍微麻烦一些，按照以下步骤进行即可。输入以下命令查看Nginx主进程号：<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">ps -ef &#124; grep "nginx: master process" &#124; grep -v "grep" &#124; awk -F ' ' '&#123;print $2&#125;'</div><br/>　　屏幕显示的即为Nginx主进程号，例如：<br/>　　<span style="color: #008000;">6302</span><br/>　　这时，执行以下命令即可使修改过的Nginx配置文件生效：<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">kill -HUP 6302</div><br/>　　或者无需这么麻烦，找到Nginx的Pid文件：<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">kill -HUP `cat /usr/local/webserver/nginx/nginx.pid`</div><br/><hr/><br/>　　<strong>七、编写每天定时切割Nginx日志的脚本</strong><br/>　　1、创建脚本/usr/local/webserver/nginx/sbin/cut_nginx_log.sh<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">vi /usr/local/webserver/nginx/sbin/cut_nginx_log.sh</div><br/>　　输入以下内容：<br/><div class="quote"><div class="quote-title">引用</div><div class="quote-content">#!/bin/bash<br/># This script run at 00:00<br/><br/># The Nginx logs path<br/>logs_path="/usr/local/webserver/nginx/logs/"<br/><br/>mkdir -p $&#123;logs_path&#125;$(date -d "yesterday" +"%Y")/$(date -d "yesterday" +"%m")/<br/>mv $&#123;logs_path&#125;access.log $&#123;logs_path&#125;$(date -d "yesterday" +"%Y")/$(date -d "yesterday" +"%m")/access_$(date -d "yesterday" +"%Y%m%d").log<br/>kill -USR1 `cat /usr/local/webserver/nginx/nginx.pid`</div></div><br/><br/>　　2、设置crontab，每天凌晨00:00切割nginx访问日志<br/><div style="border-left: 0px dashed #D6C094; margin: 5px; padding: 3px; margin-bottom:0px; border: 1px dashed #00a0c6; background-color: #ffffff;">crontab -e</div><br/>　　输入以下内容：<br/><div class="quote"><div class="quote-title">引用</div><div class="quote-content">00 00 * * * /bin/bash&nbsp;&nbsp;/usr/local/webserver/nginx/sbin/cut_nginx_log.sh</div></div><br/><br/><hr/><br/>　　本文若有小的修改，会第一时间在以下网址发布：<br/>　　<a href="http://blog.zyan.cc/nginx_php_v6/" target="_blank">http://blog.zyan.cc/nginx_php_v6/</a><br/><br/><hr/><br/>　　<strong>附：文章修改历史</strong><br/><br/>　　● [2010年03月04日] [Version 6.0] 新建<br/><br/>　　● [2010年04月16日] [Version 6.1] Nginx版本升级到0.8.35。<br/><br/>　　● [2010年05月14日] [Version 6.2] Nginx版本升级到0.8.36。MySQL版本升级到5.5.3-m3，my.cnf配置文件中的thread_concurrency、master-connect-retry参数在新版本中不支持，已经注释掉。<br/><br/>　　● [2010年07月26日] [Version 6.3] Nginx版本升级到0.8.46。PHP版本升级到5.2.14。其他软件也做了相应的升级。开启php.ini中的cgi.fix_pathinfo=0，防止Nginx文件类型错误解析漏洞。<br/><br/>　　（全文完） 

</div>
<!-- END CONTENT -->
<div id="footer">
<p><a href="#top">顶端</a></p>
<p>中文化: <a href="../index.html" >Nginx中文文档</a> &nbsp;&middot;&nbsp; 制作: nginx.cn  (整理及部分翻译 )</p>
</div>
 
</body></html>
